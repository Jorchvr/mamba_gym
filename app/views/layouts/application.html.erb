<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Black Mamba</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# CSS principal %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= yield :head %>
  </head>

  <body class="<%= content_for?(:body_class) ? yield(:body_class) : nil %>">
    <% if flash.any? %>
      <div class="flash-stack" style="position:fixed;top:8px;right:8px;z-index:9999;">
        <% flash.each do |k,v| %>
          <div class="flash <%= k %>" style="margin-bottom:6px;padding:10px 14px;border-radius:10px;background:#111;color:#fff;opacity:.95;">
            <%= v %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%= yield %>
    <%= yield :body_end %>

    <script type="module">
      import consumer from "<%= asset_path 'channels/consumer' rescue '/assets/channels/consumer' %>"

      if (!window.fingerprintSubscribed) {
        window.fingerprintSubscribed = true;
        
        consumer.subscriptions.create("FingerprintChannel", {
          connected() {
            console.log("üü¢ LECTOR LISTO: Esperando huella...");
          },

          received(data) {
            console.log("üì® DATOS RECIBIDOS:", data);

            if (data.action === 'login') {
              // ‚úÖ MAGIA AQU√ç: Redirige al HOME buscando al cliente autom√°ticamente.
              console.log("üöÄ Cargando ficha en Dashboard...");
              window.location.href = `/?search_number=${data.client_id}&commit=Buscar`;
            } 
            else if (data.action === 'registered') {
              // Recarga para ver el check verde o actualizar la vista
              location.reload();
            }
            else if (data.action === 'unknown') {
              // Solo alertamos si NO estamos registrando para no molestar
              if (!window.location.href.includes('clients/')) {
                 console.log("‚ùå Huella no reconocida");
              }
            }
          }
        });
      }
    </script>
  </body>
</html>