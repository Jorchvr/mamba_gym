<%= stylesheet_link_tag "closeout", media: "all", "data-turbo-track": "reload" %>

<div class="ticket-wrapper">
  <div class="ticket">

    <!-- â€œOnditasâ€ arriba del ticket -->
    <div class="ticket-perforation"></div>

    <!-- Encabezado -->
    <div class="ticket-header">
      <div class="ticket-logo">
        <%= image_tag "logo.png", alt: "Logo", class: "ticket-logo-img" %>
      </div>
      <div class="ticket-header-text">
        <h1 class="ticket-gym-name">PowerGym</h1>
        <p class="ticket-subtitle">Corte del dÃ­a</p>
        <p class="ticket-date">
          <%= (@date || Time.current.to_date).strftime("%Y-%m-%d") %>
          Â·
          <%= Time.current.strftime("%H:%M") %>
        </p>
      </div>
    </div>

    <div class="ticket-divider dotted"></div>

    <!-- Usuario -->
    <div class="ticket-section">
      <div class="ticket-row">
        <span class="ticket-label">Usuario</span>
        <span class="ticket-value"><%= current_user&.name || "-" %></span>
      </div>
    </div>

    <div class="ticket-divider dotted"></div>

    <!-- Resumen general -->
    <div class="ticket-section">
      <h2 class="ticket-section-title">Resumen general</h2>

      <div class="ticket-row">
        <span>Operaciones totales</span>
        <span><%= (@operations_count || @today_sales_count || 0).to_i %></span>
      </div>

      <div class="ticket-row">
        <span>Ventas de membresÃ­a</span>
        <span>
          MXN $<%= sprintf("%.2f", (@membership_total_cents || 0).to_i / 100.0) %>
        </span>
      </div>

      <div class="ticket-row">
        <span>Ventas de tienda</span>
        <span>
          MXN $<%= sprintf("%.2f", (@store_total_cents || 0).to_i / 100.0) %>
        </span>
      </div>

      <% if defined?(@negative_total_cents) && @negative_total_cents.to_i != 0 %>
        <div class="ticket-row ticket-row-negative">
          <span>Ajustes / ventas negativas</span>
          <span>
            MXN $<%= sprintf("%.2f", @negative_total_cents.to_i / 100.0) %>
          </span>
        </div>
      <% end %>

      <div class="ticket-row ticket-row-strong ticket-row-total">
        <span>Total del dÃ­a</span>
        <span>
          MXN $<%= sprintf("%.2f", (@money_total_cents || @today_total_cents || 0).to_i / 100.0) %>
        </span>
      </div>
    </div>

    <div class="ticket-divider dotted"></div>

    <!-- MÃ©todos de pago -->
    <div class="ticket-section">
      <h2 class="ticket-section-title">MÃ©todos de pago</h2>

      <% money_by_method = @money_by_method || {} %>
      <div class="ticket-row">
        <span>Efectivo</span>
        <span>MXN $<%= sprintf("%.2f", money_by_method["cash"].to_i / 100.0) %></span>
      </div>
      <div class="ticket-row">
        <span>Transferencia</span>
        <span>MXN $<%= sprintf("%.2f", money_by_method["transfer"].to_i / 100.0) %></span>
      </div>
      <% if money_by_method.except("cash","transfer").any? %>
        <% money_by_method.except("cash","transfer").each do |method, cents| %>
          <div class="ticket-row">
            <span><%= method.to_s.humanize %></span>
            <span>MXN $<%= sprintf("%.2f", cents.to_i / 100.0) %></span>
          </div>
        <% end %>
      <% end %>
    </div>

    <div class="ticket-divider dotted"></div>

    <!-- Actividad de clientes -->
    <div class="ticket-section">
      <h2 class="ticket-section-title">Actividad de clientes</h2>

      <div class="ticket-row">
        <span>Entradas (check-ins)</span>
        <span><%= (@check_ins_count || (@check_ins&.size) || @today_checkins || 0).to_i %></span>
      </div>

      <div class="ticket-row">
        <span>Nuevos clientes</span>
        <span><%= (@new_clients_count || (@new_clients&.size) || 0).to_i %></span>
      </div>
    </div>

    <% if defined?(@sold_by_product) && @sold_by_product.present? %>
      <div class="ticket-divider dotted"></div>

      <!-- Resumen por producto -->
      <div class="ticket-section">
        <h2 class="ticket-section-title">Productos vendidos</h2>
        <% @sold_by_product.first(5).each do |row| %>
          <div class="ticket-row ticket-row-small">
            <span><%= row[:product_name] %> x<%= row[:sold_qty] %></span>
            <span>MXN $<%= sprintf("%.2f", row[:revenue_cents].to_i / 100.0) %></span>
          </div>
        <% end %>
        <% if @sold_by_product.size > 5 %>
          <p class="ticket-note">â€¦ y <%= @sold_by_product.size - 5 %> productos mÃ¡s</p>
        <% end %>
      </div>
    <% end %>

    <div class="ticket-divider dotted"></div>

    <!-- Footer y â€œcÃ³digo de barrasâ€ -->
    <div class="ticket-footer">
      <p class="ticket-thanks">Â¡Gracias por tu trabajo hoy! ðŸ’ª</p>
      <p class="ticket-footer-text">
        Corte generado el <%= Time.current.strftime("%Y-%m-%d %H:%M") %>
      </p>

      <div class="ticket-barcode">
        <% 40.times do |i| %>
          <span class="barcode-line <%= 'thick' if i % 5 == 0 %>"></span>
        <% end %>
      </div>
    </div>
  </div>
</div>
