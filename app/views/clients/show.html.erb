<%# app/views/clients/show.html.erb %>
<%= stylesheet_link_tag "main_panel", media: "all", "data-turbo-track": "reload" %>

<div class="client-profile-container">

  <%# --- HEADER: T√≠tulo y Navegaci√≥n --- %>
  <div class="profile-header">
    <div class="header-left">
      <%= link_to authenticated_root_path, class: "back-link" do %>
        <span class="icon">‚Üê</span> Inicio
      <% end %>
      <span class="divider">/</span>
      <%= link_to "Clientes", clients_path, class: "back-link" %>
      <span class="divider">/</span>
      <span class="current-crumb">Ficha de Cliente</span>
    </div>
    
    <div class="header-actions">
      <%= link_to edit_client_path(@client), class: "btn btn-outline" do %>
        ‚úèÔ∏è Editar Datos
      <% end %>
    </div>
  </div>

  <%# --- TARJETA PRINCIPAL: DATOS DEL CLIENTE --- %>
  <div class="card profile-card">
    <div class="profile-grid">
      
      <%# Columna Foto %>
      <div class="photo-column">
        <div class="photo-frame">
          <% if @client.photo.attached? %>
            <%= image_tag @client.photo, class: "client-photo-img" %>
          <% else %>
            <div class="photo-placeholder">
              <span><%= @client.name.first(2).upcase %></span>
            </div>
          <% end %>
        </div>
        
        <div class="status-indicator <%= @client.next_payment_on.present? && @client.next_payment_on >= Date.current ? 'status-active' : 'status-inactive' %>">
          <%= @client.next_payment_on.present? && @client.next_payment_on >= Date.current ? 'ACTIVO' : 'VENCIDO' %>
        </div>
      </div>

      <%# Columna Informaci√≥n %>
      <div class="info-column">
        <h1 class="client-fullname"><%= @client.name %></h1>
        <div class="client-id-badge">
          <span class="label">ID Cliente:</span>
          <span class="value">#<%= @client.id %></span>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Membres√≠a Actual</span>
            <span class="info-value accent-text">
              <%= @client.membership_type.present? ? @client.membership_type.humanize : "Sin plan asignado" %>
            </span>
          </div>

          <div class="info-item">
            <span class="info-label">Fecha Inscripci√≥n</span>
            <span class="info-value"><%= @client.enrolled_on&.strftime("%d/%m/%Y") || "-" %></span>
          </div>

          <div class="info-item">
            <span class="info-label">Pr√≥ximo Vencimiento</span>
            <span class="info-value <%= (@client.next_payment_on.present? && @client.next_payment_on < Date.current) ? 'text-danger' : '' %>">
              <%= @client.next_payment_on&.strftime("%d/%m/%Y") || "-" %>
            </span>
          </div>
          
          <% if @client.age.present? %>
          <div class="info-item">
            <span class="info-label">Edad</span>
            <span class="info-value"><%= @client.age %> a√±os</span>
          </div>
          <% end %>
        </div>

        <div class="action-buttons mt-4">
          <%= link_to memberships_path(q: @client.id), class: "btn btn-primary btn-lg w-100" do %>
            üí≥ Renovar / Cobrar Mensualidad
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# --- TARJETA SECUNDARIA: GESTI√ìN DE HUELLA --- %>
  <div class="card fingerprint-card mt-4">
    <div class="card-header-row">
      <h3 class="card-title-sm">üîê Acceso Biom√©trico</h3>
      
      <div class="fingerprint-status">
        <% if @client.fingerprint.present? %>
          <span class="badge badge-success">
            <span class="dot"></span> Huella Vinculada
          </span>
        <% else %>
          <span class="badge badge-warning">
            <span class="dot"></span> Sin Huella
          </span>
        <% end %>
      </div>
    </div>

    <div class="fingerprint-actions-grid">
      
      <%# Opci√≥n A: Escaneo Directo (Solo Windows/App Local) %>
      <div class="fp-option-box">
        <div class="fp-icon">üëÜ</div>
        <div class="fp-content">
          <h4>Escaneo Directo</h4>
          <p>Usa esta opci√≥n si tienes el lector conectado a este PC.</p>
          <%= button_to "Iniciar Escaneo", start_registration_client_path(@client), method: :post, class: "btn btn-outline btn-sm w-100", form: { data: { turbo: false } } %> 
        </div>
      </div>

      <%# Opci√≥n B: Vinculaci√≥n Remota (Recomendada) %>
      <div id="manual-box" class="fp-option-box fp-option-remote">
        <div class="fp-icon">üì°</div>
        <div class="fp-content">
          <h4>Vincular Remotamente</h4>
          <p id="manual-text">Pon el dedo en el lector de recepci√≥n primero.</p>
          <%= button_to "VINCULAR √öLTIMA LE√çDA", attach_last_fingerprint_client_path(@client), method: :post, id: "btn-vincular", class: "btn btn-disabled btn-sm w-100", disabled: true %>
        </div>
      </div>

    </div>
  </div>

</div>

<%# --- SCRIPT PARA HUELLA EN TIEMPO REAL --- %>
<script>
  if (typeof consumer === 'undefined') { var consumer = ActionCable.createConsumer(); }

  consumer.subscriptions.create({ channel: "LectorHuellaChannel" }, {
    received(data) {
      if (data.action === "unknown") {
        const box = document.getElementById("manual-box");
        const btn = document.getElementById("btn-vincular");
        const text = document.getElementById("manual-text");

        // Activar visualmente la caja
        box.classList.add("active-pulse");
        
        text.innerHTML = "‚ú® ¬°Huella detectada! Lista para vincular.";
        text.style.color = "#10b981";
        text.style.fontWeight = "bold";

        // Activar bot√≥n
        btn.disabled = false;
        btn.classList.remove("btn-disabled");
        btn.classList.add("btn-success");
        btn.innerText = "üîó VINCULAR AHORA";
      }
      if (data.action === "registered") { 
        window.location.reload(); 
      }
    }
  });
</script>


<%# --- ESTILOS EXTRA PARA ESTA VISTA (Copia esto en tu main_panel.css si prefieres) --- %>
<style>
  /* Layout contenedor */
  .client-profile-container {
    max-width: 900px;
    margin: 0 auto;
    padding-bottom: 2rem;
  }

  /* Header de navegaci√≥n */
  .profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  }
  .header-left {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.95rem;
    color: #888;
  }
  .back-link {
    color: #888;
    text-decoration: none;
    transition: color 0.2s;
  }
  .back-link:hover { color: var(--btn-color); }
  .current-crumb { color: #fff; font-weight: 600; }
  .divider { opacity: 0.3; }

  /* Tarjeta de Perfil */
  .profile-card { padding: 0 !important; overflow: hidden; }
  .profile-grid {
    display: grid;
    grid-template-columns: 240px 1fr;
    gap: 0;
  }
  
  /* Columna izquierda (Foto) */
  .photo-column {
    background: rgba(0,0,0,0.2);
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    border-right: 1px solid var(--border-color);
  }
  .photo-frame {
    width: 160px;
    height: 160px;
    border-radius: 12px;
    overflow: hidden;
    border: 4px solid rgba(255,255,255,0.05);
    margin-bottom: 1rem;
    background: #000;
  }
  .client-photo-img { width: 100%; height: 100%; object-fit: cover; }
  .photo-placeholder {
    width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    background: #222; color: #444; font-size: 3rem; font-weight: 800;
  }
  
  .status-indicator {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 800;
    letter-spacing: 1px;
    width: 100%;
    text-align: center;
  }
  .status-active { background: #064e3b; color: #34d399; border: 1px solid #059669; }
  .status-inactive { background: #450a0a; color: #f87171; border: 1px solid #7f1d1d; }

  /* Columna derecha (Info) */
  .info-column { padding: 2rem; }
  .client-fullname {
    font-size: 2rem;
    font-weight: 800;
    margin: 0 0 0.5rem 0;
    color: #fff;
    line-height: 1.1;
  }
  .client-id-badge {
    display: inline-flex;
    gap: 6px;
    background: rgba(255,255,255,0.05);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 0.85rem;
    color: #888;
    margin-bottom: 1.5rem;
  }
  .client-id-badge .value { color: var(--btn-color); font-weight: bold; }

  /* Grid de informaci√≥n */
  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  .info-item { display: flex; flex-direction: column; gap: 4px; }
  .info-label { font-size: 0.8rem; text-transform: uppercase; color: #666; letter-spacing: 0.5px; }
  .info-value { font-size: 1.1rem; color: #e8ecf1; font-weight: 500; }
  .accent-text { color: var(--btn-color); font-weight: 700; }
  .text-danger { color: #f87171; }

  /* Botones espec√≠ficos */
  .btn-outline {
    background: transparent !important;
    border: 1px solid var(--border-color) !important;
    color: #ccc !important;
  }
  .btn-outline:hover {
    border-color: #fff !important;
    color: #fff !important;
  }
  .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }
  .w-100 { width: 100%; }

  /* Tarjeta de Huella */
  .card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .card-title-sm { font-size: 1.1rem; color: #fff; margin: 0; font-weight: 700; }
  
  .badge { padding: 5px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
  .badge-success { background: rgba(16, 185, 129, 0.1); color: #34d399; }
  .badge-warning { background: rgba(245, 158, 11, 0.1); color: #fbbf24; }
  .dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; }

  .fingerprint-actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }
  .fp-option-box {
    background: rgba(255,255,255,0.03);
    border: 1px dashed rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    gap: 1rem;
    transition: all 0.3s ease;
  }
  .fp-icon { font-size: 1.5rem; opacity: 0.7; }
  .fp-content h4 { font-size: 0.95rem; margin: 0 0 4px 0; color: #fff; }
  .fp-content p { font-size: 0.8rem; color: #666; margin: 0 0 12px 0; line-height: 1.4; }

  /* Estado Activo de Huella Detectada */
  .active-pulse {
    background: rgba(16, 185, 129, 0.1) !important;
    border-color: #10b981 !important;
    box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
  }
  .btn-disabled {
    background: #333 !important;
    color: #555 !important;
    cursor: not-allowed;
    border: none !important;
  }
  .btn-success {
    background: #059669 !important;
    color: #fff !important;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .profile-grid { grid-template-columns: 1fr; }
    .photo-column { border-right: none; border-bottom: 1px solid var(--border-color); padding: 1.5rem; }
    .info-column { padding: 1.5rem; }
    .info-grid { grid-template-columns: 1fr; gap: 1rem; }
    .fingerprint-actions-grid { grid-template-columns: 1fr; }
  }
</style>