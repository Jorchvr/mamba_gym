<%= stylesheet_link_tag "main_panel", media: "all", "data-turbo-track": "reload" %>

<div class="card clients-card">
  <div class="header-row clients-header" style="align-items:flex-start;">
    <div>
      <h2 class="title">Clientes</h2>


      <div class="clients-stat-row">
        <span class="stat-pill">
          Registrados: <strong><%= @clients.size %></strong>
        </span>
        <span class="stat-pill stat-pill--ok">
          Activos: <strong><%= @active_clients_count %></strong>
        </span>
      </div>
    </div>

    <div class="btn-row">
      <%= link_to "Inicio", authenticated_root_path, class: "btn" %>
      <%= link_to "Registrar Cliente", new_client_path, class: "btn btn-primary" %>
    </div>
  </div>

  <!-- üîé Buscador + filtros -->
  <%= form_with url: clients_path, method: :get, local: true do %>
    <div class="clients-filters-row">
      <div class="clients-filter-block">
        <label class="label-small">Buscar por:</label>
        <%= select_tag :filter,
          options_for_select([["N√∫mero", "id"], ["Nombre", "name"]], params[:filter].presence || "name"),
          class: "form-select" %>
      </div>

      <div class="clients-filter-block clients-filter-block--grow">
        <label class="label-small">Texto de b√∫squeda</label>
        <%= text_field_tag :q, params[:q],
          placeholder: "Escribe n√∫mero de cliente o nombre‚Ä¶",
          class: "form-input",
          style: "width:100%;" %>
      </div>

      <div class="clients-filter-block">
        <label class="label-small">Estado</label>
        <%= select_tag :status,
          options_for_select(
            [
              ["Todos", ""],
              ["Solo activos", "active"]
            ],
            params[:status].presence
          ),
          class: "form-select" %>
      </div>

      <div class="clients-filter-block clients-filter-block--button">
        <label class="label-small">&nbsp;</label>
        <%= submit_tag "Buscar", class: "btn btn-accent btn-block" %>
      </div>
    </div>
  <% end %>

  <!-- Tabla con scroll -->
  <div class="table-wrap clients-scroll">
    <table class="nice-table nice-table--clients" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>#</th>
          <th>Cliente</th>
          <th>Membres√≠a</th>
          <th>Inscripci√≥n</th>
          <th>Pr√≥ximo pago</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% @clients.each do |c| %>
          <tr class="client-row">
            <td class="muted">
              <span class="mono">#<%= c.id %></span>
            </td>

            <td>
              <div class="name-cell">
                <%= link_to (c.name.presence || "(Sin nombre)"),
                            client_path(c),
                            class: "client-name-link" %>

                <% if c.next_payment_on.present? && c.next_payment_on < Date.current %>
                  <span class="badge badge-danger">Vencida</span>
                <% elsif c.next_payment_on.present? && c.next_payment_on >= Date.current %>
                  <span class="badge badge-ok">Activa</span>
                <% else %>
                  <span class="badge">Sin plan</span>
                <% end %>
              </div>
              <div class="client-meta-mini">
                <span class="mono">Membres√≠a: <%= c.membership_type&.humanize || "-" %></span>
              </div>
            </td>

            <td>
              <span class="mono"><%= c.membership_type&.humanize || "-" %></span>
            </td>

            <td>
              <span class="mono"><%= c.enrolled_on || "-" %></span>
            </td>

            <td>
              <span class="mono"><%= c.next_payment_on || "-" %></span>
            </td>

            <td>
              <div class="actions-stack">
                <%= link_to "Ver", client_path(c), class: "btn btn-sm" %>
                <%= link_to "Editar", edit_client_path(c), class: "btn btn-sm btn-primary" %>
              </div>
            </td>
          </tr>
        <% end %>

        <% if @clients.blank? %>
          <tr>
            <td colspan="6" class="muted" style="text-align:center; padding:1.25rem 0;">
              No hay clientes que coincidan con la b√∫squeda.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
