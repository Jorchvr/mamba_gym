<%= form_with(model: @client, local: true, html: { multipart: true }) do |f| %>
  <% if @client.errors.any? %>
    <div class="card" style="border-color:#ef4444; background:rgba(239,68,68,.1); padding:.75rem 1rem; margin-bottom:1rem;">
      <strong><%= pluralize(@client.errors.count, "error") %>:</strong>
      <ul style="margin:.5rem 0 0 1rem;">
        <% @client.errors.full_messages.each do |m| %>
          <li><%= m %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="grid-2" style="gap:1rem;">
    <div class="card">
      <h3 class="card-title mb-2">Datos del cliente</h3>

      <div class="form-row">
        <%= f.label :name, "Nombre", class: "label" %>
        <%= f.text_field :name, class: "form-input", required: true %>
      </div>

      <div class="form-row">
        <%= f.label :membership_type, "Membresía", class: "label" %>
        <%= f.select :membership_type,
          options_for_select([["Día","day"],["Semana","week"],["Mes","month"]], @client.membership_type),
          { include_blank: "Sin plan" },
          class: "form-select" %>
      </div>

      <div class="form-row">
        <%= f.label :enrolled_on, "Inscripción", class: "label" %>
        <%= f.date_field :enrolled_on, class: "form-input" %>
      </div>

      <div class="form-row">
        <%= f.label :next_payment_on, "Próximo pago", class: "label" %>
        <%= f.date_field :next_payment_on, class: "form-input" %>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title mb-2">Foto</h3>

      <!-- 1) Input simple: en móvil abre cámara -->
      <div class="form-row">
        <%= f.label :photo, "Tomar/Seleccionar foto (simple)", class: "label" %>
        <%= f.file_field :photo,
              accept: "image/*;capture=camera",
              capture: "environment",
              class: "form-input",
              id: "client_photo_input" %>
        <p class="text-muted" style="margin-top:.4rem;">
          En celular abre la cámara; en computadora abre el selector del sistema.
        </p>
      </div>

      <hr style="opacity:.15; margin:.75rem 0;">

      <!-- 2) Cámara integrada (navegador) -->
      <div id="cameraBox" data-turbo="false">
        <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem;">
          <button type="button" class="btn btn-primary" id="camStartBtn">Iniciar cámara</button>
          <button type="button" class="btn" id="camStopBtn">Detener</button>
          <button type="button" class="btn btn-accent" id="camCaptureBtn">Capturar</button>
          <button type="button" class="btn" id="camUseBtn">Usar captura</button>
          <span class="text-muted" id="camStatus" style="margin-left:.5rem;"></span>
        </div>

        <video id="camVideo" autoplay playsinline muted
               style="width:100%; max-width:560px; background:#111; border-radius:.75rem;"></video>

        <canvas id="camCanvas" style="display:none;"></canvas>

        <img id="camPreview" alt="Previsualización"
             style="display:none; max-width:220px; margin-top:.5rem; border:1px solid rgba(255,255,255,.1); border-radius:.5rem;"/>
      </div>

      <% if @client.photo&.attached? %>
        <div class="form-row" style="margin-top:.75rem;">
          <label class="label">Foto actual</label>
          <div>
            <%= image_tag @client.photo, style: "max-width:220px; border:1px solid rgba(255,255,255,.1); border-radius:.5rem;" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="mt-4" style="display:flex; gap:.75rem; flex-wrap:wrap;">
    <%= f.submit class: "btn btn-primary" %>
    <%= link_to "Cancelar", (@client.persisted? ? client_path(@client) : clients_path), class: "btn" %>
    <%= link_to "Inicio", authenticated_root_path, class: "btn" %>
  </div>
<% end %>

<%# ===== JS mínimo e incrustado para la cámara ===== %>
<% content_for :body_end do %>
<script>
(function() {
  const statusEl = document.getElementById("camStatus");
  const videoEl  = document.getElementById("camVideo");
  const canvasEl = document.getElementById("camCanvas");
  const previewEl= document.getElementById("camPreview");
  const startBtn = document.getElementById("camStartBtn");
  const stopBtn  = document.getElementById("camStopBtn");
  const captBtn  = document.getElementById("camCaptureBtn");
  const useBtn   = document.getElementById("camUseBtn");
  const fileInput= document.getElementById("client_photo_input");

  let stream = null;

  function setStatus(msg){ if(statusEl){ statusEl.textContent = msg; } }

  async function startCam() {
    try {
      stopCam(); // por si acaso
      // constraints simples; el navegador elige cámara por defecto
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      videoEl.srcObject = stream;
      await videoEl.play().catch(()=>{});
      setStatus("Cámara iniciada.");
    } catch(e) {
      setStatus("No se pudo iniciar la cámara: " + e.name + " — " + e.message);
      if (e.name === "NotAllowedError") {
        setStatus("Permiso denegado. Activa la cámara en el candado del navegador.");
      }
      if (e.name === "NotFoundError") {
        setStatus("No hay cámara disponible.");
      }
    }
  }

  function stopCam() {
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      setStatus("Cámara detenida.");
    }
    if (videoEl) { videoEl.srcObject = null; }
  }

  function capture() {
    if (!stream) { setStatus("Inicia la cámara antes de capturar."); return; }
    const w = videoEl.videoWidth || 640;
    const h = videoEl.videoHeight || 480;
    canvasEl.width = w; canvasEl.height = h;
    const ctx = canvasEl.getContext("2d");
    ctx.drawImage(videoEl, 0, 0, w, h);
    const dataUrl = canvasEl.toDataURL("image/jpeg", 0.92);
    previewEl.src = dataUrl;
    previewEl.style.display = "inline-block";
    setStatus("Foto capturada. Pulsa 'Usar captura' para adjuntarla.");
  }

  async function useCapture() {
    if (!previewEl.src) { setStatus("No hay captura disponible."); return; }
    try {
      const res  = await fetch(previewEl.src);
      const blob = await res.blob();
      const file = new File([blob], "captura.jpg", { type: "image/jpeg" });
      const dt   = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files; // ← ADJUNTA AL MISMO :photo
      setStatus("Captura adjuntada al formulario.");
    } catch(e) {
      setStatus("Error al adjuntar: " + e.message);
    }
  }

  // Eventos
  if (startBtn) startBtn.addEventListener("click", startCam);
  if (stopBtn)  stopBtn.addEventListener("click", stopCam);
  if (captBtn)  captBtn.addEventListener("click", capture);
  if (useBtn)   useBtn.addEventListener("click", useCapture);

  // Si sales de la página, corta la cámara (Turbo u otros)
  document.addEventListener("turbo:before-cache", stopCam);
})();
</script>
<% end %>
