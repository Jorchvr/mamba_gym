<%# app/views/clients/_form.html.erb %>
<% prices = defined?(Client::PRICES) ? Client::PRICES : { "day" => 3000, "week" => 12000, "month" => 26500 } %>
<% d, w, m = prices["day"]/100.0, prices["week"]/100.0, prices["month"]/100.0 %>

<%# üî• CORRECCI√ìN FINAL: Usamos 'enctype' expl√≠cito para forzar la subida de archivos %>
<%= form_with(model: client, local: true, html: { enctype: "multipart/form-data", id: "client-form", data: { turbo: "false" } }) do |f| %>
  
  <% if client.errors.any? %>
    <div class="card" style="border-color:#ef4444; background:rgba(239,68,68,.1); padding:1rem; margin-bottom:1rem; color:#ef4444;">
      <ul><% client.errors.full_messages.each do |msg| %><li><%= msg %></li><% end %></ul>
    </div>
  <% end %>

  <div class="grid-2" style="gap:1rem;">
    <div class="card">
      <h3 class="card-title mb-2">Datos del Cliente</h3>
      
      <div class="form-row">
        <%= f.label :name, "Nombre", class: "label" %>
        <%= f.text_field :name, class: "form-input", required: true, placeholder: "Ej. Juan P√©rez" %>
      </div>

      <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <div>
          <%= f.label :age, "Edad", class: "label" %>
          <%= f.number_field :age, class: "form-input", placeholder: "25" %>
        </div>
        <div>
          <%= f.label :height, "Altura (m)", class: "label" %>
          <%= f.number_field :height, step: 0.01, class: "form-input", placeholder: "1.75" %>
        </div>
      </div>
       <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <div>
          <%= f.label :weight, "Peso (kg)", class: "label" %>
          <%= f.number_field :weight, step: 0.01, class: "form-input", placeholder: "80.0" %>
        </div>
        <div>
           <%= f.label :membership_type, "Membres√≠a", class: "label" %>
           <%= f.select :membership_type, 
              options_for_select([["D√≠a - $#{d.to_i}", "day"], ["Semana - $#{w.to_i}", "week"], ["Mes - $#{m.to_i}", "month"]], client.membership_type),
              { include_blank: "Seleccionar..." }, 
              class: "form-select", id: "mem_select" %>
        </div>
      </div>
      <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <div><%= f.label :enrolled_on, "Inscripci√≥n", class: "label" %> <%= f.date_field :enrolled_on, class: "form-input" %></div>
        <div><%= f.label :next_payment_on, "Pr√≥ximo pago", class: "label" %> <%= f.date_field :next_payment_on, class: "form-input" %></div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title mb-2">Foto de Perfil</h3>

      <%# Este es el input oculto que recibe la foto real %>
      <%= f.file_field :photo, accept: "image/*", style: "display:none;", id: "real_file" %>

      <div style="background:#000; border:1px solid #444; border-radius:8px; overflow:hidden; min-height:220px; position:relative; display:flex; justify-content:center; align-items:center;">
        <video id="gymVideo" autoplay playsinline muted style="width:100%; height:auto; display:none;"></video>
        <canvas id="gymCanvas" style="display:none;"></canvas>
        <img id="gymPreview" style="width:100%; display:none;">
        
        <div id="gymPlaceholder" style="text-align:center;">
          <% if client.photo.attached? %>
             <%# Muestra la foto actual si existe %>
             <%= image_tag client.photo, style: "max-width:120px; border-radius:5px;" %>
             <p style="color:#aaa; font-size:0.8rem;">Actual</p>
          <% else %>
            <div style="font-size:3rem;">üì∑</div>
            <p style="color:#666;">Sin foto</p>
          <% end %>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; flex-direction:column; gap:5px;">
        <button type="button" class="btn btn-primary" id="btnStartCam">üîå Encender C√°mara</button>
        
        <select id="gymCamSelect" class="form-input" style="display:none;"></select>
        
        <div id="gymActions" style="display:none; gap:5px;">
          <button type="button" class="btn btn-accent" style="flex:1;" id="btnSnap">üì∏ Capturar</button>
          <button type="button" class="btn btn-danger" id="btnStop">‚ùå</button>
        </div>
        
        <button type="button" class="btn btn-success" id="btnConfirmPhoto" style="display:none;">‚úÖ Usar Foto</button>
        
        <button type="button" class="btn btn-sm" onclick="document.getElementById('real_file').click()" style="background:#333; margin-top:5px;">üìÅ Subir Archivo</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:1rem;">
    <% if client.new_record? %>
      <h4 class="card-title">Pago</h4>
      <div class="grid-2" style="gap:1rem;">
        <div><label class="label">Total</label><%= number_field_tag :registration_price_mxn, ('%.2f' % m), class: "form-input", id: "gymPriceInput" %></div>
        <div>
           <label class="label">M√©todo</label>
           <div style="display:flex; gap:10px;">
             <label style="color:#fff;"><input type="radio" name="client[payment_method]" value="cash" checked> Efectivo</label>
             <label style="color:#fff;"><input type="radio" name="client[payment_method]" value="transfer"> Transferencia</label>
           </div>
        </div>
      </div>
      <%= f.submit "Guardar Cliente", class: "btn btn-primary w-full mt-4" %>
    <% else %>
      <%= f.submit "Actualizar Datos", class: "btn btn-primary w-full mt-4" %>
    <% end %>
  </div>
<% end %>

<script>
(function() {
  console.log("üöÄ Iniciando script de c√°mara...");

  let stream = null;
  const video = document.getElementById('gymVideo');
  const canvas = document.getElementById('gymCanvas');
  const preview = document.getElementById('gymPreview');
  const placeholder = document.getElementById('gymPlaceholder');
  const select = document.getElementById('gymCamSelect');
  const actions = document.getElementById('gymActions');
  const btnStart = document.getElementById('btnStartCam');
  const btnSnap = document.getElementById('btnSnap');
  const btnStop = document.getElementById('btnStop');
  const btnConfirm = document.getElementById('btnConfirmPhoto');
  const realFile = document.getElementById('real_file');
  const priceInput = document.getElementById('gymPriceInput');
  const memSelect = document.getElementById('mem_select');

  // L√≥gica de Precios
  if(memSelect && priceInput) {
    memSelect.addEventListener('change', function() {
      const txt = this.options[this.selectedIndex].text;
      if(txt.includes('$')) priceInput.value = parseFloat(txt.split('$')[1]).toFixed(2);
    });
  }

  // FUNCIONES DE C√ÅMARA
  async function startCamera(deviceId = null) {
    try {
      // 1. Permisos
      const initStream = await navigator.mediaDevices.getUserMedia({ video: true });
      initStream.getTracks().forEach(t => t.stop()); // Solo permiso

      // 2. Listar
      if(select.options.length === 0) {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const inputs = devices.filter(d => d.kind === 'videoinput');
        select.innerHTML = '<option value="">-- Cambiar --</option>';
        inputs.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.text = d.label || `C√°mara ${i+1}`;
          select.appendChild(opt);
        });
        if(inputs.length > 1) select.style.display = 'block';
      }

      // 3. Iniciar Stream
      const constraints = { video: deviceId ? { deviceId: { exact: deviceId } } : true };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      video.style.display = 'block';
      await video.play();

      // UI
      placeholder.style.display = 'none';
      btnStart.style.display = 'none';
      actions.style.display = 'flex';
      preview.style.display = 'none';
      btnConfirm.style.display = 'none';

    } catch(err) {
      alert("‚ö†Ô∏è Error: " + err.message + "\n\nIMPORTANTE: Usa http://localhost:3000 (no 127.0.0.1) para que Brave permita la c√°mara.");
    }
  }

  function snap() {
    if(!stream) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    preview.src = canvas.toDataURL('image/jpeg');
    
    video.style.display = 'none';
    preview.style.display = 'block';
    actions.style.display = 'none';
    btnConfirm.style.display = 'block';
    
    // Pausar stream
    stream.getTracks().forEach(t => t.stop());
  }

  function save() {
    fetch(preview.src)
      .then(res => res.blob())
      .then(blob => {
        const file = new File([blob], "foto_cam.jpg", { type: "image/jpeg" });
        const dt = new DataTransfer();
        dt.items.add(file);
        realFile.files = dt.files;
        alert("‚úÖ Foto lista para guardar.");
        btnConfirm.style.display = 'none';
        select.style.display = 'none';
      });
  }

  function stop() {
    if(stream) stream.getTracks().forEach(t => t.stop());
    video.style.display = 'none';
    placeholder.style.display = 'block';
    btnStart.style.display = 'block';
    actions.style.display = 'none';
    select.style.display = 'none';
  }

  // LISTENERS DIRECTOS
  if(btnStart) btnStart.onclick = () => startCamera();
  if(select) select.onchange = () => startCamera(select.value);
  if(btnSnap) btnSnap.onclick = snap;
  if(btnStop) btnStop.onclick = stop;
  if(btnConfirm) btnConfirm.onclick = save;

})();
</script>