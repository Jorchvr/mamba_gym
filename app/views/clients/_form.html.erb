<%# app/views/clients/_form.html.erb %>

<% 
  # Definimos las opciones de membres√≠a con sus etiquetas y precios para la vista
  # (Deben coincidir con las claves del modelo)
  membership_options = [
    { code: 'visit',    label: 'Visita',    price: 100 },
    { code: 'week',     label: 'Semana',    price: 200 },
    { code: 'month',    label: 'Mes',       price: 550 },
    { code: 'couple',   label: 'Pareja',    price: 950 },
    { code: 'semester', label: 'Semestre',  price: 2300 }
  ]
%>

<%# --- ESTILOS CSS PARA LOS BOTONES Y C√ÅMARA --- %>
<style>
  /* Estilo para los botones de membres√≠a (Radio Buttons disfrazados) */
  .plan-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); /* Se adaptan al espacio */
    gap: 8px;
    margin-top: 5px;
  }

  .plan-option input[type="radio"] {
    display: none; /* Ocultamos el c√≠rculo del radio */
  }

  .plan-option label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 5px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    height: 100%;
  }

  .plan-option label .plan-name {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 2px;
  }

  .plan-option label .plan-price {
    font-size: 0.75rem;
    color: #aaa;
  }

  /* Estado seleccionado */
  .plan-option input[type="radio"]:checked + label {
    background: var(--btn-color); /* Color dorado/amarillo */
    border-color: var(--btn-color);
    color: #000; /* Texto negro para contraste */
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  .plan-option input[type="radio"]:checked + label .plan-price {
    color: #333; /* Precio oscuro cuando est√° seleccionado */
    font-weight: bold;
  }

  /* Estilos C√°mara */
  .camera-container {
    background: #000;
    border: 1px solid #444;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-width: 320px;
    aspect-ratio: 4/3;
    margin: 0 auto;
  }
  #gymVideo, #gymPreview { width: 100%; height: 100%; object-fit: cover; display: none; }
  #gymPlaceholder { text-align: center; width: 100%; }
</style>

<%= form_with(model: client, local: true, html: { enctype: "multipart/form-data", id: "client-form", data: { turbo: "false" } }) do |f| %>
  
  <%= f.hidden_field :photo_base64, id: "photo_base64_input" %>

  <%# Fecha de inscripci√≥n oculta (siempre es HOY por defecto al crear) %>
  <%= f.hidden_field :enrolled_on, value: (client.enrolled_on || Date.current), id: "enrolled_input" %>

  <% if client.errors.any? %>
    <div class="card" style="border-color:#ef4444; background:rgba(239,68,68,.1); padding:1rem; margin-bottom:1rem; color:#ef4444;">
      <ul><% client.errors.full_messages.each do |msg| %><li><%= msg %></li><% end %></ul>
    </div>
  <% end %>

  <% if @next_id.present? && client.new_record? %>
    <div style="margin-bottom:1rem; padding:10px; border-left:4px solid var(--btn-color); background:rgba(255,255,255,0.03);">
      <span style="font-weight:700; color:var(--text-color);">PR√ìXIMO SOCIO: <span style="color:var(--btn-color);">#<%= @next_id %></span></span>
    </div>
  <% end %>

  <div class="grid-2" style="gap:1rem;">
    
    <div class="card">
      <h3 class="card-title mb-2">Datos del Cliente</h3>
      
      <div class="form-row">
        <%= f.label :name, "Nombre Completo", class: "label" %>
        <%= f.text_field :name, class: "form-input", required: true, placeholder: "Ej. Juan P√©rez" %>
      </div>

      <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <div>
          <%= f.label :age, "Edad", class: "label" %>
          <%= f.number_field :age, class: "form-input", placeholder: "25" %>
        </div>
        <div>
           <label class="label">Membres√≠a</label>
           <div class="plan-grid">
             <% membership_options.each do |opt| %>
               <div class="plan-option">
                 <%= f.radio_button :membership_type, opt[:code], 
                     id: "plan_#{opt[:code]}", 
                     data: { price: opt[:price], type: opt[:code] } %>
                 <label for="plan_<%= opt[:code] %>">
                   <span class="plan-name"><%= opt[:label] %></span>
                   <span class="plan-price">$<%= opt[:price] %></span>
                 </label>
               </div>
             <% end %>
           </div>
        </div>
      </div>
      
      <div style="margin-top: 1rem;">
        <%= f.label :next_payment_on, "Fecha de Vencimiento (Pr√≥ximo Pago)", class: "label label-strong" %>
        <%= f.date_field :next_payment_on, class: "form-input form-input--xl", id: "next_pay_input", required: true %>
        <p class="text-muted" style="font-size: 0.8rem; margin-top: 4px;">
          üìÖ Se calcula autom√°ticamente a partir de hoy, pero puedes cambiarla.
        </p>
      </div>

    </div>

    <div class="card">
      <h3 class="card-title mb-2">Foto de Perfil</h3>
      <%= f.file_field :photo, accept: "image/*", style: "display:none;", id: "real_file" %>

      <div class="camera-container">
        <video id="gymVideo" autoplay playsinline muted></video>
        <canvas id="gymCanvas" style="display:none;"></canvas>
        <img id="gymPreview">
        
        <div id="gymPlaceholder">
          <% if client.photo.attached? %>
             <%= image_tag client.photo, style: "max-width:100px; max-height:100px; border-radius:5px;" %>
             <p style="color:#aaa; font-size:0.8rem;">Actual</p>
          <% else %>
            <div style="font-size:3rem;">üì∑</div>
            <p style="color:#666;">Sin foto</p>
          <% end %>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; flex-direction:column; gap:5px; max-width:320px; margin-left:auto; margin-right:auto;">
        <button type="button" class="btn btn-primary" id="btnStartCam">üîå Encender C√°mara</button>
        <select id="gymCamSelect" class="form-input" style="display:none;"></select>
        <div id="gymActions" style="display:none; gap:5px;">
          <button type="button" class="btn btn-accent" style="flex:1;" id="btnSnap">üì∏ Capturar</button>
          <button type="button" class="btn btn-danger" id="btnStop">‚ùå</button>
        </div>
        <button type="button" class="btn btn-success" id="btnConfirmPhoto" style="display:none;">‚úÖ Foto Lista</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:1rem;">
    <% if client.new_record? %>
      <h4 class="card-title">Cobro Inicial</h4>
      <div class="grid-2" style="gap:1rem;">
        <div>
          <label class="label">Total a Pagar (MXN)</label>
          <%= number_field_tag :registration_price_mxn, nil, class: "form-input", id: "gymPriceInput", placeholder: "0.00" %>
        </div>
        <div>
           <label class="label">M√©todo</label>
           <div style="display:flex; gap:10px; align-items: center; height: 42px;">
             <label style="color:#fff; cursor:pointer;"><input type="radio" name="client[payment_method]" value="cash" checked> Efectivo</label>
             <label style="color:#fff; cursor:pointer;"><input type="radio" name="client[payment_method]" value="transfer"> Tarjeta</label>
           </div>
        </div>
      </div>
      <%= f.submit "Guardar y Cobrar", class: "btn btn-primary w-full mt-4" %>
    <% else %>
      <%= f.submit "Actualizar Datos", class: "btn btn-primary w-full mt-4" %>
    <% end %>
  </div>
<% end %>

<script>
(function() {
  console.log("üöÄ L√≥gica V5: Botones Est√©ticos + Fechas Autom√°ticas");

  const planRadios = document.querySelectorAll('input[name="client[membership_type]"]');
  const priceInput = document.getElementById('gymPriceInput');
  const nextPayInput = document.getElementById('next_pay_input');
  
  // Fecha base siempre es HOY para nuevos registros (Inscripci√≥n oculta)
  // Nota: Para editar cliente existente, deber√≠amos usar su fecha real, pero aqu√≠ asumimos l√≥gica de "cobrar hoy" o "renovar desde hoy" si se cambia el plan.
  const today = new Date(); 

  // Funci√≥n para calcular fecha
  function calculateDate(planType) {
    let date = new Date(); // Copia de hoy

    if (planType === 'visit') {
      date.setDate(date.getDate() + 1);
    } else if (planType === 'week') {
      date.setDate(date.getDate() + 7);
    } else if (planType === 'month' || planType === 'couple') {
      date.setMonth(date.getMonth() + 1);
    } else if (planType === 'semester') {
      date.setMonth(date.getMonth() + 6);
    }
    return date.toISOString().split('T')[0];
  }

  // Escuchar cambios en los botones de radio
  planRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if(this.checked) {
        // 1. Actualizar Precio
        const price = this.getAttribute('data-price');
        if(priceInput) priceInput.value = price + ".00";

        // 2. Actualizar Fecha Autom√°ticamente
        const planType = this.getAttribute('data-type');
        const newDateStr = calculateDate(planType);
        
        if(nextPayInput) {
          nextPayInput.value = newDateStr;
          // Efecto visual para indicar cambio
          nextPayInput.style.borderColor = "var(--btn-color)";
          setTimeout(() => nextPayInput.style.borderColor = "", 500);
        }
      }
    });
  });


  // === L√ìGICA DE C√ÅMARA (Sin cambios, se mantiene funcional) ===
  let stream = null;
  const video = document.getElementById('gymVideo');
  const canvas = document.getElementById('gymCanvas');
  const preview = document.getElementById('gymPreview');
  const placeholder = document.getElementById('gymPlaceholder');
  const select = document.getElementById('gymCamSelect');
  const actions = document.getElementById('gymActions');
  const btnStart = document.getElementById('btnStartCam');
  const btnSnap = document.getElementById('btnSnap');
  const btnStop = document.getElementById('btnStop');
  const btnConfirm = document.getElementById('btnConfirmPhoto');

  async function startCamera(deviceId = null) {
    try {
      if (stream) stream.getTracks().forEach(t => t.stop());
      const initStream = await navigator.mediaDevices.getUserMedia({ video: true });
      initStream.getTracks().forEach(t => t.stop());

      if(select.options.length === 0) {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const inputs = devices.filter(d => d.kind === 'videoinput');
        select.innerHTML = '<option value="">-- Cambiar --</option>';
        inputs.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.text = d.label || `C√°mara ${i+1}`;
          select.appendChild(opt);
        });
        if(inputs.length > 1) select.style.display = 'block';
      }

      const constraints = { video: { deviceId: deviceId ? { exact: deviceId } : undefined, width: { ideal: 640 }, height: { ideal: 480 } } };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      video.style.display = 'block';
      placeholder.style.display = 'none';
      preview.style.display = 'none';
      await video.play();

      btnStart.style.display = 'none';
      actions.style.display = 'flex';
      btnConfirm.style.display = 'none';
    } catch(err) {
      alert("‚ö†Ô∏è Error c√°mara: " + err.message);
    }
  }

  function snap() {
    if(!stream) return;
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    preview.src = canvas.toDataURL('image/jpeg');
    const hiddenInput = document.getElementById('photo_base64_input');
    if(hiddenInput) hiddenInput.value = preview.src;
    video.style.display = 'none';
    preview.style.display = 'block';
    actions.style.display = 'none';
    btnConfirm.style.display = 'block'; 
    stream.getTracks().forEach(t => t.stop());
  }

  function stop() {
    if(stream) stream.getTracks().forEach(t => t.stop());
    video.style.display = 'none';
    preview.style.display = 'none';
    placeholder.style.display = 'block';
    btnStart.style.display = 'block';
    actions.style.display = 'none';
    select.style.display = 'none';
    btnConfirm.style.display = 'none';
  }

  if(btnStart) btnStart.onclick = () => startCamera();
  if(select) select.onchange = () => startCamera(select.value);
  if(btnSnap) btnSnap.onclick = snap;
  if(btnStop) btnStop.onclick = stop;
  if(btnConfirm) btnConfirm.onclick = () => { btnConfirm.style.display = 'none'; select.style.display = 'none'; };
})();
</script>