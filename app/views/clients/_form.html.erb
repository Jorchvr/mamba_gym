<%# app/views/clients/_form.html.erb %>
<% prices = defined?(Client::PRICES) ? Client::PRICES : { "day" => 3000, "week" => 12000, "month" => 26500 } %>
<% d, w, m = prices["day"]/100.0, prices["week"]/100.0, prices["month"]/100.0 %>

<%# --- ESTILOS INCRUSTADOS PARA EL TAMA√ëO DE LA C√ÅMARA --- %>
<style>
  /* Contenedor principal de la c√°mara */
  .camera-container {
    background: #000;
    border: 1px solid #444;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    
    /* TAMA√ëO FIJO Y PEQUE√ëO */
    width: 100%;
    max-width: 320px;       /* Ancho m√°ximo de celular */
    aspect-ratio: 4/3;      /* Proporci√≥n cuadrada/rectangular est√°ndar */
    margin: 0 auto;         /* Centrado horizontal */
  }

  /* El video y el preview deben respetar el contenedor */
  #gymVideo, #gymPreview {
    width: 100%;
    height: 100%;
    object-fit: cover;      /* Rellena el cuadro sin deformar */
    display: none;          /* Ocultos por defecto */
  }

  /* Placeholder (icono de c√°mara) */
  #gymPlaceholder {
    text-align: center;
    width: 100%;
  }
</style>

<%# üî• Formulario con Enctype para subir archivos y Turbo desactivado para evitar conflictos JS %>
<%= form_with(model: client, local: true, html: { enctype: "multipart/form-data", id: "client-form", data: { turbo: "false" } }) do |f| %>
  
  <%# === 1. CAMPO OCULTO (Aqu√≠ se guarda la foto de la c√°mara) === %>
  <%= f.hidden_field :photo_base64, id: "photo_base64_input" %>

  <% if client.errors.any? %>
    <div class="card" style="border-color:#ef4444; background:rgba(239,68,68,.1); padding:1rem; margin-bottom:1rem; color:#ef4444;">
      <ul><% client.errors.full_messages.each do |msg| %><li><%= msg %></li><% end %></ul>
    </div>
  <% end %>

  <%# === 2. AVISO DE PR√ìXIMO SOCIO (Solo nuevos) === %>
  <% if @next_id.present? && client.new_record? %>
    <div style="margin-bottom:1rem; padding:10px; border-left:4px solid var(--btn-color); background:rgba(255,255,255,0.03);">
      <span style="font-weight:700; color:var(--text-color);">PR√ìXIMO SOCIO: <span style="color:var(--btn-color);">#<%= @next_id %></span></span>
    </div>
  <% end %>

  <div class="grid-2" style="gap:1rem;">
    <div class="card">
      <h3 class="card-title mb-2">Datos del Cliente</h3>
      
      <div class="form-row">
        <%= f.label :name, "Nombre", class: "label" %>
        <%= f.text_field :name, class: "form-input", required: true, placeholder: "Ej. Juan P√©rez" %>
      </div>

      <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <div>
          <%= f.label :age, "Edad", class: "label" %>
          <%= f.number_field :age, class: "form-input", placeholder: "25" %>
        </div>
        <div>
          <%= f.label :height, "Altura (m)", class: "label" %>
          <%= f.number_field :height, step: 0.01, class: "form-input", placeholder: "1.75" %>
        </div>
      </div>
       <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <div>
          <%= f.label :weight, "Peso (kg)", class: "label" %>
          <%= f.number_field :weight, step: 0.01, class: "form-input", placeholder: "80.0" %>
        </div>
        <div>
           <%= f.label :membership_type, "Membres√≠a", class: "label" %>
           <%= f.select :membership_type, 
              options_for_select([["D√≠a - $#{d.to_i}", "day"], ["Semana - $#{w.to_i}", "week"], ["Mes - $#{m.to_i}", "month"]], client.membership_type),
              { include_blank: "Seleccionar..." }, 
              class: "form-select", id: "mem_select" %>
        </div>
      </div>
      <div class="grid-2" style="gap:.5rem; margin-top:.5rem;">
        <%# === 3. FECHAS CON IDs PARA AUTOMATIZACI√ìN === %>
        <div><%= f.label :enrolled_on, "Inscripci√≥n", class: "label" %> <%= f.date_field :enrolled_on, class: "form-input", id: "enrolled_input" %></div>
        <div><%= f.label :next_payment_on, "Pr√≥ximo pago", class: "label" %> <%= f.date_field :next_payment_on, class: "form-input", id: "next_pay_input" %></div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title mb-2">Foto de Perfil</h3>

      <%# Input tradicional oculto por si quieren subir archivo %>
      <%= f.file_field :photo, accept: "image/*", style: "display:none;", id: "real_file" %>

      <%# --- CONTENEDOR DE C√ÅMARA CON CLASE NUEVA --- %>
      <div class="camera-container">
        <video id="gymVideo" autoplay playsinline muted></video>
        <canvas id="gymCanvas" style="display:none;"></canvas>
        <img id="gymPreview">
        
        <div id="gymPlaceholder">
          <% if client.photo.attached? %>
             <%= image_tag client.photo, style: "max-width:100px; max-height:100px; border-radius:5px;" %>
             <p style="color:#aaa; font-size:0.8rem;">Actual</p>
          <% else %>
            <div style="font-size:3rem;">üì∑</div>
            <p style="color:#666;">Sin foto</p>
          <% end %>
        </div>
      </div>

      <div style="margin-top:10px; display:flex; flex-direction:column; gap:5px; max-width:320px; margin-left:auto; margin-right:auto;">
        <button type="button" class="btn btn-primary" id="btnStartCam">üîå Encender C√°mara</button>
        
        <select id="gymCamSelect" class="form-input" style="display:none;"></select>
        
        <div id="gymActions" style="display:none; gap:5px;">
          <button type="button" class="btn btn-accent" style="flex:1;" id="btnSnap">üì∏ Capturar</button>
          <button type="button" class="btn btn-danger" id="btnStop">‚ùå</button>
        </div>
        
        <button type="button" class="btn btn-success" id="btnConfirmPhoto" style="display:none;">‚úÖ Foto Lista</button>
        
        <button type="button" class="btn btn-sm" onclick="document.getElementById('real_file').click()" style="background:#333; margin-top:5px;">üìÅ Subir Archivo</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:1rem;">
    <% if client.new_record? %>
      <h4 class="card-title">Pago</h4>
      <div class="grid-2" style="gap:1rem;">
        <div><label class="label">Total</label><%= number_field_tag :registration_price_mxn, ('%.2f' % m), class: "form-input", id: "gymPriceInput" %></div>
        <div>
           <label class="label">M√©todo</label>
           <div style="display:flex; gap:10px;">
             <label style="color:#fff;"><input type="radio" name="client[payment_method]" value="cash" checked> Efectivo</label>
             <label style="color:#fff;"><input type="radio" name="client[payment_method]" value="transfer"> Transferencia</label>
           </div>
        </div>
      </div>
      <%= f.submit "Guardar Cliente", class: "btn btn-primary w-full mt-4" %>
    <% else %>
      <%= f.submit "Actualizar Datos", class: "btn btn-primary w-full mt-4" %>
    <% end %>
  </div>
<% end %>

<script>
(function() {
  console.log("üöÄ Iniciando script de c√°mara V3 (Tama√±o Corregido)...");

  let stream = null;
  const video = document.getElementById('gymVideo');
  const canvas = document.getElementById('gymCanvas');
  const preview = document.getElementById('gymPreview');
  const placeholder = document.getElementById('gymPlaceholder');
  const select = document.getElementById('gymCamSelect');
  const actions = document.getElementById('gymActions');
  const btnStart = document.getElementById('btnStartCam');
  const btnSnap = document.getElementById('btnSnap');
  const btnStop = document.getElementById('btnStop');
  const btnConfirm = document.getElementById('btnConfirmPhoto');
  const realFile = document.getElementById('real_file');
  const priceInput = document.getElementById('gymPriceInput');
  const memSelect = document.getElementById('mem_select');
  const nextPayInput = document.getElementById('next_pay_input');
  const enrolledInput = document.getElementById('enrolled_input');

  // === 1. L√ìGICA DE PRECIOS Y FECHAS ===
  if(memSelect) {
    memSelect.addEventListener('change', function() {
      // Precio
      const txt = this.options[this.selectedIndex].text;
      if(priceInput && txt.includes('$')) priceInput.value = parseFloat(txt.split('$')[1]).toFixed(2);

      // Fecha Autom√°tica
      const plan = this.value;
      let date = (enrolledInput && enrolledInput.value) ? new Date(enrolledInput.value + "T12:00:00") : new Date();

      if(plan === 'month' || plan === 'mes') date.setMonth(date.getMonth() + 1);
      else if(plan === 'week' || plan === 'semana') date.setDate(date.getDate() + 7);
      else if(plan === 'day' || plan === 'dia') date.setDate(date.getDate() + 1);

      if(nextPayInput) nextPayInput.value = date.toISOString().split('T')[0];
    });
  }

  // === 2. FUNCIONES DE C√ÅMARA MEJORADAS ===
  async function startCamera(deviceId = null) {
    try {
      // Detener stream anterior si existe
      if (stream) stream.getTracks().forEach(t => t.stop());

      // Permisos iniciales
      const initStream = await navigator.mediaDevices.getUserMedia({ video: true });
      initStream.getTracks().forEach(t => t.stop()); // Solo para pedir permiso

      // Llenar select de c√°maras si est√° vac√≠o
      if(select.options.length === 0) {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const inputs = devices.filter(d => d.kind === 'videoinput');
        select.innerHTML = '<option value="">-- Cambiar --</option>';
        inputs.forEach((d, i) => {
          const opt = document.createElement('option');
          opt.value = d.deviceId;
          opt.text = d.label || `C√°mara ${i+1}`;
          select.appendChild(opt);
        });
        if(inputs.length > 1) select.style.display = 'block';
      }

      // Configuraci√≥n de resoluci√≥n ideal (No forzar demasiado para evitar errores)
      const constraints = { 
        video: {
          deviceId: deviceId ? { exact: deviceId } : undefined,
          width: { ideal: 640 },  // Pedimos resoluci√≥n baja/media para que sea r√°pido
          height: { ideal: 480 }
        }
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      
      // Mostrar video y ocultar placeholder
      video.style.display = 'block';
      placeholder.style.display = 'none';
      preview.style.display = 'none';
      
      await video.play();

      btnStart.style.display = 'none';
      actions.style.display = 'flex';
      btnConfirm.style.display = 'none';

    } catch(err) {
      alert("‚ö†Ô∏è Error c√°mara: " + err.message + "\nPrueba usando localhost o HTTPS.");
    }
  }

  function snap() {
    if(!stream) return;
    
    // Ajustar canvas al tama√±o real del video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    
    // Generar imagen
    preview.src = canvas.toDataURL('image/jpeg');
    
    // GUARDADO AUTOM√ÅTICO
    const hiddenInput = document.getElementById('photo_base64_input');
    if(hiddenInput) hiddenInput.value = preview.src;

    // Cambiar vistas
    video.style.display = 'none';
    preview.style.display = 'block';
    actions.style.display = 'none';
    
    btnConfirm.style.display = 'block'; 
    
    // Detener la c√°mara para ahorrar recursos
    stream.getTracks().forEach(t => t.stop());
  }

  function stop() {
    if(stream) stream.getTracks().forEach(t => t.stop());
    video.style.display = 'none';
    preview.style.display = 'none';
    placeholder.style.display = 'block';
    
    btnStart.style.display = 'block';
    actions.style.display = 'none';
    select.style.display = 'none';
    btnConfirm.style.display = 'none';
  }

  if(btnStart) btnStart.onclick = () => startCamera();
  if(select) select.onchange = () => startCamera(select.value);
  if(btnSnap) btnSnap.onclick = snap;
  if(btnStop) btnStop.onclick = stop;
  if(btnConfirm) btnConfirm.onclick = () => { btnConfirm.style.display = 'none'; select.style.display = 'none'; };

})();
</script>